{% extends 'base.html' %}
{% load static %}

{% block title %}–°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π{% endblock %}

{% block content %}
  <h2 class="mt-3 mb-4">üè∑Ô∏è –°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π</h2>

  {% if messages %}
    <div class="container mb-4">
      {% for msg in messages %}
        <div class="alert alert-{{ msg.tags }}">{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="mb-4">
    <a href="{% url 'sms_blinoff:add_mother' %}?next=mother_list" class="btn btn-success">
      ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–Ω—Å–∫—É—é –∫–æ–º–ø–∞–Ω–∏—é
    </a>
  </div>

  <div class="table-responsive">
    <table id="alfa-table" class="table table-striped table-bordered">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>–ò–º—è</th>
          <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
        </tr>
      </thead>
      <tbody>
        {% for m in mothers %}
          <tr>
            <td>{{ m.id }}</td>
            <td>{{ m.name }}</td>
            <td>{{ m.creation_date }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="3" class="text-center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <button class="btn btn-success mb-3" onclick="exportToExcel()">
    üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
  </button>
{% endblock %}

{% block scripts %}
  {{ block.super }}

  <script>
    $(function(){
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DataTable
      const table = $('#alfa-table').DataTable({
        orderCellsTop: true,
        fixedHeader: true,
        language: {
          search: "–ü–æ–∏—Å–∫:",
          lengthMenu: "–ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∑–∞–ø–∏—Å–µ–π",
          zeroRecords: "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ",
          info: "–ü–æ–∫–∞–∑–∞–Ω–æ _START_‚Äì_END_ –∏–∑ _TOTAL_",
          paginate: { previous: "‚Üê", next: "‚Üí" }
        }
      });

      // –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ (–Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
      window.exportToExcel = function() {
        // 1) –ó–∞–≥–æ–ª–æ–≤–∫–∏
        const headers = [];
        $('#alfa-table thead th').each(function(){
          headers.push($(this).text().trim());
        });

        // 2) –î–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
        const allData = table.rows().data().toArray();

        // 3) –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
        const rowsForExport = allData.map(row => {
          const obj = {};
          row.forEach((cell, idx) => {
            obj[ headers[idx] ] = cell;
          });
          return obj;
        });

        // 4) –°–æ–∑–¥–∞—ë–º –∫–Ω–∏–≥—É –∏ –ª–∏—Å—Ç
        const ws = XLSX.utils.json_to_sheet(rowsForExport, { header: headers });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏");

        // 5) –°–∫–∞—á–∏–≤–∞–µ–º
        XLSX.writeFile(wb, "MotherListReport.xlsx");
      };
    });
  </script>
{% endblock %}
