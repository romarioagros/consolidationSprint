{% extends 'base.html' %}

{% block title %}Paymed Sms{% endblock %}

{% block content %}
<h2 class="mt-3 mb-4">üìã —Å–ø–∏—Å–æ–∫  –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ  SMS </h2>

<div class="mb-4">

    ‚ûï –î–æ–±–∞–≤–∏—Ç—å Service
  </a>
</div>

<div class="table-responsive">
  <table id="services-table" class="table table-striped table-bordered">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>TRANK ID</th>
        <th>—Å—É–º–º–∞ –≤ —Ä—É–± </th>
        <th>–¥–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞</th>
        <th>–∫–æ–ª-–≤–æ —Å–º—Å</th>
        <th>–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∫–∞ </th>
      
      </tr>
    </thead>
    <tbody>
      {% for s in payments %}
      <tr>
        <td>{{ s.id }}</td>
        <td>{{ s.comp_id }}</td>
        <td>{{ s.amount }}</td>
        <td>{{ s.date_payment }}</td>
        <td>{{ s.amount_sms }}</td>
        <td>{{ s.company_name }}</td>
        
    </tr>
      {% empty %}
      <tr><td colspan="10" class="text-center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <button class="btn btn-success mb-3" onclick="exportToExcel()">
    üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
  </button>

</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    $(function(){
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DataTable
      const table = $('#services-table').DataTable({
        orderCellsTop: true,
        fixedHeader: true,
        language: {
          search: "–ü–æ–∏—Å–∫:",
          lengthMenu: "–ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∑–∞–ø–∏—Å–µ–π",
          zeroRecords: "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ",
          info: "–ü–æ–∫–∞–∑–∞–Ω–æ _START_‚Äì_END_ –∏–∑ _TOTAL_",
          paginate: { previous: "‚Üê", next: "‚Üí" }
        }
      });

      // –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ (–Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
      window.exportToExcel = function() {
        // 1) –ó–∞–≥–æ–ª–æ–≤–∫–∏
        const headers = [];
        $('#services-table thead th').each(function(){
          headers.push($(this).text().trim());
        });

        // 2) –î–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
        const allData = table.rows().data().toArray();

        // 3) –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
        const rowsForExport = allData.map(row => {
          const obj = {};
          row.forEach((cell, idx) => {
            obj[ headers[idx] ] = cell;
          });
          return obj;
        });

        // 4) –°–æ–∑–¥–∞—ë–º –∫–Ω–∏–≥—É –∏ –ª–∏—Å—Ç
        const ws = XLSX.utils.json_to_sheet(rowsForExport, { header: headers });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "–æ–ø–ª–∞—Ç—ã");

        // 5) –°–∫–∞—á–∏–≤–∞–µ–º
        XLSX.writeFile(wb, "Paymed_sms.xlsx");
      };
    });
  </script>
{% endblock %}
