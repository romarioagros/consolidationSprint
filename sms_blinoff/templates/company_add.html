{% extends 'base.html' %}

{% block title %}–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é{% endblock %}

{% block content %}
<h2 class="mt-3 mb-4">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</h2>

{% if messages %}
  <div class="container mb-4">
    {% for msg in messages %}
      <div class="alert alert-{{ msg.tags }}">{{ msg }}</div>
    {% endfor %}
  </div>
{% endif %}

<form method="post" class="row g-2 mb-4">
  {% csrf_token %}
  {# 1. –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ next #}
  <input type="hidden" name="next" value="{{ next|default:"add_account" }}">

  <!-- 1) –ù–∞–∑–≤–∞–Ω–∏–µ (name) -->
  <div class="col-md-4">
    <label for="account_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ (name):</label>
    <input type="text" name="account_name" id="account_name" class="form-control"
           required value="{{ prev_account_name }}">
  </div>

  <!-- 2) –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (legal_name) -->
  <div class="col-md-4">
    <label for="legal_name" class="form-label">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (legal_name):</label>
    <input type="text" name="legal_name" id="legal_name" class="form-control"
           required value="{{ prev_legal_name }}">
  </div>

  <!-- 3) –ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è (select + —Å—Å—ã–ª–∫–∞ –Ω–∞ add_mother —Å next) -->
  <div class="col-md-4">
    <label for="mother_id" class="form-label">–ú–∞—Ç–µ—Ä–∏–Ω—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è:</label>
    <div class="input-group">
      <select name="mother_id" id="mother_id" class="form-select" required>
        <option value="" disabled {% if not prev_mother_id %}selected{% endif %}>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
        {% for mother in mothers %}
          <option value="{{ mother.id }}"
                  {% if mother.id|stringformat:"s" == prev_mother_id|stringformat:"s" %}selected{% endif %}>
            {{ mother.name }}
          </option>
        {% endfor %}
      </select>

      {# 2. –í —Å—Å—ã–ª–∫–µ –ø–µ—Ä–µ–¥–∞—ë–º next=current view #}
      <a href="{% url 'sms_blinoff:add_mother' %}?next=add_account"
         class="btn btn-outline-secondary"
         title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∞—Ç.–∫–æ–º–ø–∞–Ω–∏—é">
        ‚ûï
      </a>
    </div>
    <div class="form-text">
      –ï—Å–ª–∏ –Ω—É–∂–Ω–æ–π –º–∞—Ç–µ—Ä–∏–Ω—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ, –Ω–∞–∂–º–∏—Ç–µ ¬´‚ûï¬ª –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ—ë.
    </div>
  </div>

  <div class="col-12"></div>

  <!-- 4) –ê–ª–∏–∞—Å—ã (alians) -->
  <div class="col-12">
    <label class="form-label">–ê–ª–∏–∞—Å—ã (alians):</label>
    <div id="alians-container">
      {% if prev_aliases %}
        {% for alias in prev_aliases %}
          <div class="input-group mb-2">
            <input type="text" name="alians" class="form-control"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ alias" value="{{ alias }}">
            <button type="button" class="btn btn-outline-danger btn-remove-alias">‚úñ</button>
          </div>
        {% endfor %}
      {% else %}
        <div class="input-group mb-2">
          <input type="text" name="alians" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ alias">
          <button type="button" class="btn btn-outline-danger btn-remove-alias">‚úñ</button>
        </div>
      {% endif %}
    </div>
    <button id="add-alias-btn" type="button" class="btn btn-sm btn-outline-primary">
      ‚ûï –î–æ–±–∞–≤–∏—Ç—å alias
    </button>
  </div>

  <!-- 5) –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é -->
  <div class="col-12 mt-4">
    <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</button>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const container = document.getElementById("alians-container");
  const addBtn = document.getElementById("add-alias-btn");

  function createAliasField(value = "") {
    const wrapper = document.createElement("div");
    wrapper.classList.add("input-group", "mb-2");

    const input = document.createElement("input");
    input.type = "text";
    input.name = "alians";
    input.placeholder = "–í–≤–µ–¥–∏—Ç–µ alias";
    input.classList.add("form-control");
    input.value = value;

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.classList.add("btn", "btn-outline-danger", "btn-remove-alias");
    removeBtn.textContent = "‚úñ";
    removeBtn.addEventListener("click", () => wrapper.remove());

    wrapper.append(input, removeBtn);
    return wrapper;
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö alias
  document.querySelectorAll(".btn-remove-alias").forEach(btn =>
    btn.addEventListener("click", function() {
      this.closest(".input-group").remove();
    })
  );

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ alias
  addBtn.addEventListener("click", () => {
    container.appendChild(createAliasField());
  });
});
</script>
{% endblock %}
