{% extends 'base.html' %}


    <meta charset="UTF-8" />
    {% block title %}–°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π{% endblock %}
    {% block content %}    
    <style>
        /* –ü—Ä–æ—Å—Ç—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
        table {
            border-collapse: collapse;
            width: 100%;
        }
        td, th {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #eee;
        }
    </style>

    <h1>–°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π</h1>
    <button class="btn btn-success mb-3" onclick="exportToExcel()">
        üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
    </button>

    <h2 class="mt-3 mb-4">üìä –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∫</h2>

    {% if messages %}
  <div class="container mb-4">
            {% for msg in messages %}
            <div class="alert alert-{{ msg.tags }}">{{ msg }}</div>
            {% endfor %}
        </div>
        {% endif %}

        {# –ö–Ω–æ–ø–∫–∞ ¬´–î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç¬ª #}
        <div class="mb-4">
        <a href="{% url 'sms_blinoff:add_account' %}" class="btn btn-success">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
        </a>
</div>




    {% if companies %}
        <table id="report-table" class="table table-bordered table-striped table-sm">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ (name)</th>
                    <th>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (legal_name)</th>
                    <th>–ê–ª–∏–∞—Å (alians)</th>
                    <th>Mother Name</th>
                </tr>
            </thead>
            <tbody>
                {% for company in companies %}
                <tr>
                    <td>{{ company.id }}</td>
                    <td>{{ company.name }}</td>
                    <td>{{ company.legal_name }}</td>
                    <td>{{ company.alians }}</td>
                    <td>{{ company.name_m }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>–í –±–∞–∑–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ <code>companies</code>.</p>
    {% endif %}

    {% if messages %}
    <div class="container mt-3">
      {% for msg in messages %}
        <div class="alert alert-{{ msg.tags }}">{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}






    {% endblock %}

    {% block scripts %}
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
  $(document).ready(function () {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DataTable, –Ω–∞–ø—Ä–∏–º–µ—Ä:
    let table = $('#report-table').DataTable({
      orderCellsTop: true,
      fixedHeader: true,
      language: {
        search: "–ü–æ–∏—Å–∫:",
        lengthMenu: "–ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∑–∞–ø–∏—Å–µ–π",
        zeroRecords: "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ",
        info: "–ü–æ–∫–∞–∑–∞–Ω–æ _START_‚Äì_END_ –∏–∑ _TOTAL_",
        paginate: { previous: "‚Üê", next: "‚Üí" }
      }
    });

    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    window.exportToExcel = function() {
      // 1) –ú–∞—Å—Å–∏–≤ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
      let headers = [];
      $('#report-table thead th').each(function() {
        headers.push($(this).text().trim());
      });

      // 2) –ë–µ—Ä—ë–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (–Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É)
      let allData = table.rows().data().toArray();

      // 3) –°–æ–±–∏—Ä–∞–µ–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
      let rowsForExport = allData.map(function(row) {
        return {
          [headers[0]]: row[0],
          [headers[1]]: row[1],
          [headers[2]]: row[2],
          [headers[3]]: row[3],
          [headers[4]]: row[4]
        };
      });

      // 4) –°–æ–∑–¥–∞—ë–º worksheet –∏ workbook
      let ws = XLSX.utils.json_to_sheet(rowsForExport, { header: headers });
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "–û—Ç—á—ë—Ç");

      // 5) –°–∫–∞—á–∏–≤–∞–µ–º
      XLSX.writeFile(wb, "companies_report.xlsx");
    };
  });

  document.addEventListener("DOMContentLoaded", function() {
        const container = document.getElementById("alians-container");
        const addBtn = document.getElementById("add-alias-btn");

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ input –¥–ª—è alias
        function createAliasInput(value = "") {
            const wrapper = document.createElement("div");
            wrapper.classList.add("input-group", "mb-2");

            const input = document.createElement("input");
            input.setAttribute("type", "text");
            input.setAttribute("name", "alians");
            input.setAttribute("placeholder", "–í–≤–µ–¥–∏—Ç–µ alias");
            input.classList.add("form-control");
            input.value = value;

            const removeBtn = document.createElement("button");
            removeBtn.setAttribute("type", "button");
            removeBtn.classList.add("btn", "btn-outline-danger", "btn-remove-alias");
            removeBtn.textContent = "‚úñ";

            // –ü—Ä–∏ –∫–ª–∏–∫–µ –ø–æ ¬´‚úñ¬ª —É–¥–∞–ª—è–µ–º —ç—Ç—É –≥—Ä—É–ø–ø—É
            removeBtn.addEventListener("click", function() {
                container.removeChild(wrapper);
            });

            wrapper.appendChild(input);
            wrapper.appendChild(removeBtn);
            return wrapper;
        }

        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –ø—É—Å—Ç–æ–π input
        container.appendChild(createAliasInput());

        // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ ¬´–î–æ–±–∞–≤–∏—Ç—å alias¬ª ‚Äî
        addBtn.addEventListener("click", function() {
            container.appendChild(createAliasInput());
        });
    });

</script>
{% endblock %}
