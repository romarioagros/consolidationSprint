{% extends 'base.html' %}

{% block title %}SMS Services{% endblock %}

{% block content %}
<h2 class="mt-3 mb-4">üìã –°–ø–∏—Å–æ–∫ SMS Services</h2>

<div class="mb-4">

    ‚ûï –î–æ–±–∞–≤–∏—Ç—å Service
  </a>
</div>

<div class="table-responsive">
  <table id="services-table" class="table table-striped table-bordered">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Mother ID</th>
        <th>Mother Name</th>
        <th>Descr</th>
        <th>Agreement</th>
        <th>Price</th>
        <th>Currency</th>
        <th>Type</th>
        <th>Created At</th>
        <th>IP Address</th>
      </tr>
    </thead>
    <tbody>
      {% for s in services %}
      <tr>
        <td>{{ s.id }}</td>
        <td>{{ s.mother_id }}</td>
        <td>{{ s.mother_name }}</td>
        <td>{{ s.descr }}</td>
        <td>{{ s.agreement }}</td>
        <td>{{ s.price }}</td>
        <td>{{ s.currency }}</td>
        <td>{{ s.type }}</td>
        <td>{{ s.created_at }}</td>
        <td>{{ s.ip_address }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="10" class="text-center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <button class="btn btn-success mb-3" onclick="exportToExcel()">
    üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
  </button>

</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    $(function(){
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DataTable
      const table = $('#services-table').DataTable({
        orderCellsTop: true,
        fixedHeader: true,
        language: {
          search: "–ü–æ–∏—Å–∫:",
          lengthMenu: "–ü–æ–∫–∞–∑–∞—Ç—å _MENU_ –∑–∞–ø–∏—Å–µ–π",
          zeroRecords: "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ",
          info: "–ü–æ–∫–∞–∑–∞–Ω–æ _START_‚Äì_END_ –∏–∑ _TOTAL_",
          paginate: { previous: "‚Üê", next: "‚Üí" }
        }
      });

      // –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ (–Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
      window.exportToExcel = function() {
        // 1) –ó–∞–≥–æ–ª–æ–≤–∫–∏
        const headers = [];
        $('#services-table thead th').each(function(){
          headers.push($(this).text().trim());
        });

        // 2) –î–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
        const allData = table.rows().data().toArray();

        // 3) –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
        const rowsForExport = allData.map(row => {
          const obj = {};
          row.forEach((cell, idx) => {
            obj[ headers[idx] ] = cell;
          });
          return obj;
        });

        // 4) –°–æ–∑–¥–∞—ë–º –∫–Ω–∏–≥—É –∏ –ª–∏—Å—Ç
        const ws = XLSX.utils.json_to_sheet(rowsForExport, { header: headers });
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "services");

        // 5) –°–∫–∞—á–∏–≤–∞–µ–º
        XLSX.writeFile(wb, "Services.xlsx");
      };
    });
  </script>
{% endblock %}
