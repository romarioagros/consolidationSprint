{% extends 'base.html' %}
{% block title %}DN numbers{% endblock %}

{% block content %}
<h2 class="mt-3 mb-4">üÖ∞Ô∏è –°–ø–∏—Å–æ–∫ –∫–æ–ø–º–∞–Ω–∏–π –∏–º–µ—é—â–∏—Ö Dn-numbers</h2>

<div class="mb-3">
  <button id="export-btn" class="btn btn-success">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
</div>  

<div class="mb-4 d-flex gap-2">
  <a href="{% url 'sms_blinoff:add_alfa' %}" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å Df-–Ω–æ–º–µ—Ä</a>
  <button id="edit-selected-btn" class="btn btn-warning" disabled>üõ† –ú–∞—Å—Å–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
</div>

<div class="table-responsive">
  <table id="alfa-table" class="table table-bordered table-striped table-sm datatable">
    <thead class="table-light">
      <tr>
        <th><input type="checkbox" id="select-all"></th>
        <th>ID</th>
        <th>ID Comp</th>
        <th>Name Comp</th>
        <th>Price</th>
        <th>valid from</th>
        <th>valid to </th>
        <th>‚úèÔ∏è</th>
        <th>üìÑ</th>
      </tr>
    </thead>
    <tbody>
      {% for a in companies %}
        <tr>
          <td><input type="checkbox" class="row-checkbox" value="{{ a.id }}"></td>
          <td>{{ a.id }}</td>
          <td>{{ a.id_comp }}</td>
          <td>{{ a.name }}</td>
          <td>{{ a.price }}</td>
          <td>{{ a.valid_from }}</td>
          <td>{{ a.valid_to }}</td>
          <td><a href="{% url 'sms_blinoff:edit_alfa' a.id %}" class="btn btn-sm btn-outline-primary">‚úèÔ∏è</a></td>
          <td><a href="{% url 'sms_blinoff:copy_alfa' a.id %}" class="btn btn-sm btn-outline-success">üìÑ</a></td>
        </tr>
      {% empty %}
        <tr><td colspan="12" class="text-center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const editBtn = document.getElementById('edit-selected-btn');
    const selectAll = document.getElementById('select-all');

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π DataTable
    const table = $('#alfa-table').DataTable();

    function updateEditButtonState() {
      const anyChecked = $('.row-checkbox:checked', table.rows({ search: 'applied' }).nodes()).length > 0;
      editBtn.disabled = !anyChecked;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ç–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
    selectAll.addEventListener('change', function () {
      const checked = this.checked;
      table.rows({ search: 'applied' }).every(function () {
        const node = this.node();
        const checkbox = node.querySelector('.row-checkbox');
        if (checkbox) checkbox.checked = checked;
      });
      updateEditButtonState();
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
    $('#alfa-table').on('change', '.row-checkbox', updateEditButtonState);

    // –ö–Ω–æ–ø–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    editBtn.addEventListener('click', function () {
      const selectedIds = $('.row-checkbox:checked', table.rows({ search: 'applied' }).nodes())
        .map(function () {
          return this.value;
        }).get();

      if (selectedIds.length === 0) return;

      const url = "{% url 'sms_blinoff:mass_edit_alfa' %}?ids=" + selectedIds.join(",");
      window.location.href = url;
    });
  });
</script>
{% endblock %}
